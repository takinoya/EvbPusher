#!/usr/bin/env python3

import os
import sys
import errno
import socket

class EvbPusherClient:
    def __init__(self, socket_path):
        self.socket_path = socket_path

    def do_comm(self, message):
        s = self.socket = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
        #s.settimeout(5.5)
        s.connect(self.socket_path)
        #sys.stdout.write("send: {}\n".format(message))
        s.send(message.encode())
        data = s.recv(4096)
        #sys.stdout.write("receive:\n")
        sys.stdout.write("{}\n".format(data.decode()))
        s.close()

def print_usage():
    sys.stdout.write("usage: evbpusher-cmd [-h] [--sock SOCK] CMDLINE_TO_EVBP\n")
    sys.stdout.write("\n")
    sys.stdout.write("positional arguments:\n")
    sys.stdout.write("  CMDLINE_TO_EVBP    Commandline string to EvbPusher.\n")
    sys.stdout.write("\n")
    sys.stdout.write("optional arguments:\n")
    sys.stdout.write("  -h, --help         Show this help message and exit\n")
    sys.stdout.write("  --sock SOCK_PATH   Change socket path of evbpusher-srv.\n")
    sys.stdout.write("                     (For debug or multi point service)\n")
    sys.stdout.write("  -v, --verbose      Enable verbose debug message.\n")
    sys.stdout.write("\n")

if __name__ == '__main__':
    sock_path = '/tmp/evbpusher.sock'
    verb_enabled = False
    argc = len(sys.argv)
    args = sys.argv
    if argc < 2 :
        sys.stderr.write("Argument error: This command needs at least 1 arguments.\n")
        print_usage()
        sys.exit(errno.EINVAL)
        
    if args[1] == "-h" or args[1] == "--help" :
        print_usage()
        sys.exit()
        
    while True:
        if args[1] == "--sock":
            if argc < 4 :
                sys.stderr.write("Argument error: Not enough number of arguments.\n")
                sys.exit(errno.EINVAL)
            sock_path = args[2]
            del args[1:2]
            argc = len(args)
            continue
        elif args[1] == "-v" or args[1] == "--verbose" :
            verb_enabled = True
            del args[1]
            argc = len(args)
            continue
        else :
            break

    send_str = ""
    for v in range(1, argc):
        send_str += args[v]
        send_str += " "
    
    if len(send_str) > 256 :
        sys.stderr.write("Argument error: CMDLINE_TO_EVBP is too big (max 256 bytes).\n")
        sys.exit(errno.E2BIG)
        
    if verb_enabled :
        sys.stderr.write("Debug: send_str = {}\n".format(send_str))
    
    if os.path.exists(sock_path):
        client = EvbPusherClient(sock_path)
        client.do_comm(send_str)
    else:
        sys.stderr.write("Service error: Socket of evbpusher-srv ({}) is not ready.\n".format(sock_path))
        sys.exit(errno.EUNATCH)
